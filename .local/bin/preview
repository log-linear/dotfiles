#!/usr/bin/sh

# General-purpose CLI file previewer script. Pairs well with fzf --preview

file=$(readlink -f "$1")
xdg_type=$(xdg-mime query filetype "$file")
fcat=$(echo "$xdg_type" | sed 's/\/.*//g')
ftype=$(echo "$xdg_type" | sed 's/.*\///g')

case "$fcat" in
  text)
    case "$ftype" in
      html)
        pandoc "$1" -t markdown \
        | bat --theme=base16 --style=numbers --color=always -l md ;;
      tab-separated-values|\
      csv)
        tidy-viewer -c 5 -a -n 90 "$1" ;;
      rtf)
        catdoc "$1" | bat --theme=base16 --style=numbers --color=always ;;
      *)
        bat --theme=base16 --style=numbers --color=always "$1" ;;
    esac ;;
  application)
    case "$ftype" in
      pdf|\
      postscript)
        pdftotext "$1" - \
        | bat --theme=base16 --style=numbers --color=always ;;
      x-extension-html|\
      x-extension-htm|\
      x-extension-shtml|\
      x-extension-xhtml|\
      x-extension-xht)
        pandoc "$1" -t markdown \
        | bat --theme=base16 --style=numbers --color=always ;;
      json|\
      xml|\
      x-shellscript|\
      javascript|\
      sql|\
      x-perl)
        bat --theme=base16 --style=numbers --color=always "$1" ;;
      rtf|\
      msword)
        catdoc "$1" | bat --theme=base16 --style=numbers --color=always ;;
      vnd.openxmlformats-officedocument.wordprocessingml.document)
        pandoc "$1" -t markdown \
        | bat --theme=base16 --style=numbers --color=always -l md ;;
      vnd.ms-excel)
        xls2csv "$1" | tidy-viewer -c 5 -a -n 90 ;;
      vnd.openxmlformats-officedocument.spreadsheetml.sheet)
        xlsx2csv "$1" | tidy-viewer -c 5 -a -n 90 ;;
      vnd.openxmlformats-officedocument.presentationml.presentation)
        unzip -qc "$1" ppt/slides/slide*.xml \
        | grep -oP '(?<=\<a:t\>).*?(?=\</a:t\>)' \
        | bat --theme=base16 --style=numbers --color=always ;;
      *)
        exiftool "$1" ;;
    esac ;;
  inode)
    tree -C "$1" | head -200 ;;
  image)
    catimg -w "$(tput cols)" "$1" ;;
  *)
    exiftool "$1" ;;
esac

